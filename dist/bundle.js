
class HN{static BASE="https://hacker-news.firebaseio.com/v0";static top=new HN("top");static new=new HN("new");static ask=new HN("ask");static job=new HN("job");static best=new HN("best");static show=new HN("show");constructor(t){t.user?this.id="user":this.id=t,this.url=HN.getURL(t)}static getURI(t){switch(typeof t){case"string":return`${t}stories.json`;case"number":return`item/${t}.json`;case"object":if(t.user)return`user/${t.user}.json`;default:throw Error("Invalid URI id")}}static getURL(t){return`${HN.BASE}/${HN.getURI(t)}`}}
class Client{static fetchPosts(t){return fetch(HN[t].url).then(Client.receive).catch(console.error)}static fetchItems(t){return Promise.all(t.map(t=>fetch(HN.getURL(t)).then(Client.receive)))}static receive(t){if(!t.ok)throw Error(`Client Error: ${t.status}`);return t.json()}}
class Query{static container(e){return e instanceof Page?e:e.querySelector("section")}static countChildren(e){return e instanceof Page?e.querySelectorAll("& > article")?.length||0:e.querySelectorAll("& > details > section > article")?.length||0}static loader(e){return e instanceof Page?e.querySelector("& > button"):e.querySelector("& > details > section > button")}static reply(e){return e.parentElement instanceof Page?e.querySelector("& > details > section > form"):e.querySelector("& > form")}static text(e){return e.parentElement instanceof Page?e.querySelector("& > details > section > div"):e.querySelector("& > div")}}

class Store{static DB_NAME=document.title;static STORE_NAME="items";static VERSION=1;static CACHE_LIFE=3e5;constructor(){const t=window.indexedDB.open(Store.DB_NAME,Store.VERSION);t.onerror=this.throwError("Initializing"),t.onupgradeneeded=this.upgrade.bind(this),t.onsuccess=({target:t})=>{this.database=t.result}}createStore(t){console.log("Creating store...");let r=t.createObjectStore(Store.STORE_NAME);r.createIndex("id","id",{unique:!0}),r.createIndex("title","title",{unique:!1})}find(t){return new Promise((r,e)=>{this.transact("readonly",e=>{let o=e.get(t);return o.onsuccess=({target:t})=>{r(t.result)},o})})}retrieve(t){return Promise.all(t.map(this.find.bind(this))).then(r=>{let e=r.filter(t=>t&&Date.now()-t.savedAt<Store.CACHE_LIFE),o=t.filter(t=>0===e.filter(r=>r.id===t).length);return{foundItems:e,missingIds:o}})}migrate(t,r){if(!t||!r.transaction)return;let e=r.transaction.objectStore(Store.STORE_NAME),o=e.openCursor();o.onerror=this.throwError("Migration"),o.onsuccess=({target:r})=>{let o=r.result;if(!o)return console.log("Migration complete.");let s=t(o.value),i=e.put(s,s.id);i.onerror=this.throwError(`Migrating task ${s.id}`),i.onsuccess=t=>{console.log(`Migrated item ${t.target.result}.`)},o.continue()}}save(t){return new Promise((r,e)=>{this.transact("readwrite",e=>{t.savedAt=Date.now();let o=e.put(t,t.id);return o.onsuccess=t=>{r(t.target.result)},o})})}saveAll(t){return Promise.all(t.map(this.save.bind(this)))}throwError(t){return({target:r})=>{throw Error(`Store Error: ${t}`,{cause:r.error})}}transact(t,r){let e=r(this.database.transaction(Store.STORE_NAME,t).objectStore(Store.STORE_NAME));return e&&(e.onerror=this.throwError("Transaction")),e}upgrade({target:t,oldVersion:r}){let e=t.result;e.onerror=this.throwError("Upgrade"),e.objectStoreNames.contains(Store.STORE_NAME)?e.version!==Store.VERSION&&(console.log(`Migrating version ${r} to ${e.version}.`),1===r&&this.migrate(null,t)):this.createStore(e)}}
class Model{store=new Store;list(e,t,n){switch(typeof n){case"string":if("user"===n)return Client.fetchPosts(n).then(({submitted:n})=>n.slice(e,e+t));return Client.fetchPosts(n).then(n=>n.slice(e,e+t));case"number":return this.store.find(n).then(({kids:n})=>n.slice(e,e+t));default:return this.unit(this.unit([]))}}load({cursor:e,count:t,id:n}){return this.list(e,t,n).then(this.store.retrieve.bind(this.store)).then(this.reload.bind(this)).catch(console.error)}reload({foundItems:e,missingIds:t}){return new Promise((n,r)=>t.length?Client.fetchItems(t).then(t=>{let s=t?.filter(e=>e).length;return s&&s===t.length?this.store.saveAll(t).then(()=>n(t.concat(e))):r(t)}):e.length?n(e):r({foundItems:e,missingIds:t}))}unit(e){return new Promise(t=>t(e))}}
class View extends HTMLElement{static model=new Model;static EVENT_LOAD="load";constructor(){super(),this.addEventListener(View.EVENT_LOAD,({detail:e,target:t})=>{let r=View.render(t);View.model.load(e).then(e=>(r.setAttribute("value","90"),e)).then(Page.render(t)).then(View.finish(t))})}static render(e){let t=Query.container(e),r=document.createElement("progress");return r.setAttribute("max","100"),r.setAttribute("value","30"),t.insertAdjacentElement("afterbegin",r),r}static finish(e){return()=>{let t=e.querySelector("progress");t.setAttribute("value","100"),t.setAttribute("style","visibility: hidden"),setTimeout(()=>e.querySelector("progress").remove(),100)}}static stopEvent(e){e.stopPropagation()}static loadEvent(e,t,r){return new CustomEvent(View.EVENT_LOAD,{bubbles:!0,detail:{cursor:e,count:t,id:r}})}static normalize(e,t=!1){return e.deleted||e.dead||"[delayed]"===e.text?null:(e.kids||(e.kids=[]),"job"===e.type?(e.upvote=!1,e.downvote=!1,e.reply=!1,delete e.score,delete e.by):("comment"===e.type?(e.upvote=t,e.downvote=t):(e.upvote=t,e.downvote=!1),e.reply=t),e)}}
class Page extends View{static TAG="app-page";static PAYLOAD=13;load(){let e=Query.countChildren(this),t=View.loadEvent(e,Page.PAYLOAD,this.id);return this.dispatchEvent(t)}static onLoad(e){return e.stopPropagation(),e.target.parentElement.load()}static render(e){return t=>{let n=Query.loader(e),a=Query.container(e),r=document.querySelector("main").isConnected,o=e.parentElement instanceof Page&&0===Query.countChildren(e);if(t.forEach(e=>{let t=View.normalize(e,r);if(!t)return;let i=Item.render(t);n?a.insertBefore(i,n):a.appendChild(i),o&&t.kids.length>0&&Item.onLoad({stopPropagation:()=>{},target:Query.loader(document.getElementById(t.id)),payload:t.kids.length>5?2:1})}),e instanceof Page&&!n){let t=document.createElement("button");t.textContent=`Load more
    \u{25BC}`,t.addEventListener("click",Page.onLoad),e.appendChild(t)}}}}customElements.define(Page.TAG,Page);
    
class Tabs extends HTMLElement{static TAG="app-nav";constructor(){super()}initialize(){this.querySelectorAll('a[role="tab"]').forEach(e=>this.bindEvent(e)),location.hash.length?this.change(location.hash):document.querySelector(`${Page.TAG}.active`).load()}add(e,t){let a=document.createElement("a");a.setAttribute("href",`#${e}`),a.textContent=t||e,this.bindEvent(a),this.appendChild(a)}bindEvent(e){e.addEventListener("click",this.onChange.bind(this))}onChange(e){e.stopPropagation(),e.preventDefault();let t=e.target.getAttribute("href");location.hash!==t&&(location.hash=t,this.change(t)),scrollTo(0,0)}change(e){document.querySelector("nav .active")?.classList.remove("active"),document.querySelector("main > .active")?.classList.remove("active");let t=document.querySelector(e);if(document.querySelector(`nav a[href="${e}"]`).classList.add("active"),t.classList.add("active"),"#login"!==e){if(!t)throw Error("Page does not exist");Query.countChildren(t)||t.load()}}}customElements.define(Tabs.TAG,Tabs,{extends:"nav"});
class Item{static PAYLOAD=3;static close(e){let t=e.querySelector("details");return t?.removeAttribute("open"),t}static isOpen(e){let t=e.querySelector("details");return t?.getAttribute("open")===""}static open(e){let t=e.querySelector("details");return t?.setAttribute("open",""),t}static toggleOpen(e){return Item.isOpen(e)?Item.close(e):Item.open(e)}static onLoad(e){e.stopPropagation();let t=e.target,n=t.closest("article"),r=e.payload||Item.PAYLOAD,o=Query.countChildren(n),l=n.getAttribute("data-kids"),i=l>r?l-o:l,a=i>r?i-r:0;n.setAttribute("data-kids",a),a>0?t.textContent=`\u{271B}${a}`:t.remove(),Item.open(n);let c=Number(n.getAttribute("id")),s=View.loadEvent(o,r,c);return n.dispatchEvent(s)}static onExpand(e){e.stopPropagation();let t=e.target.closest("article"),n=Query.loader(t);Item.toggleOpen(t),!Query.countChildren(t)&&n&&n.click()}static onReply(e){e.stopPropagation();let t=e.target.closest("article"),n=Query.reply(t);if(n)return n.classList.toggle("hidden");let r=document.getElementById("reply").content.cloneNode(!0).querySelector("form"),o=t.getAttribute("id");r.setAttribute("action",`/reply/${o}`),r.addEventListener("submit",Item.onSubmit);let l=Query.text(t),i=t.parentElement instanceof Page;if(i&&!l){let e=t.querySelector("& > details > section");if(!e){let n=document.createElement("details"),r=document.createElement("summary");e=document.createElement("section"),n.appendChild(r),n.appendChild(e),t.appendChild(n)}e.insertAdjacentElement("afterbegin",r)}else l.insertAdjacentElement("afterend",r);i&&!Item.isOpen(t)&&Item.open(t)}static onSubmit(e){e.stopPropagation(),e.preventDefault();let t=e.target,n=t.getAttribute("action"),r=t.querySelector("textarea"),o=r.value;fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({[r.getAttribute("name")]:o})}).then(e=>{if(e.ok){let e=document.querySelector("main"),n={id:0,by:e.user,text:o,time:Date.now()/1e3,type:"comment"},r=View.normalize(n,e.isConnected),l=Item.render(r);t.replaceWith(l)}})}static onVote(e){e.stopPropagation();let t=e.target,n=t.closest("article"),r=n.parentElement instanceof Page,o=t.getAttribute("name"),l=n.getAttribute("id");fetch(`/${o}/${l}`).then(e=>{e.ok&&(r||("upvote"===o?t.nextElementSibling.remove():t.previousElementSibling.remove()),t.remove())})}static render(e){let t=document.getElementById("item").content.cloneNode(!0),n=t.querySelector("article");n.setAttribute("id",e.id),n.setAttribute("data-kids",e.kids.length);let r=t.querySelector("h1");if(e.title){let n=t.querySelector("a");e.url?(n.setAttribute("href",e.url),n.textContent=e.title,n.addEventListener("click",View.stopEvent)):(n.remove(),r.textContent=e.title),r.addEventListener("click",Item.onExpand)}else r.remove();let o=t.querySelector("h2"),l=o.querySelector('button[name="upvote"]');e.upvote?l.addEventListener("click",Item.onVote):l.remove();let i=o.querySelector('button[name="downvote"]');e.downvote?i.addEventListener("click",Item.onVote):i.remove();let a=o.querySelector("b");e.score?a.textContent=`${e.score}`:a.remove();let c=o.querySelector("i");e.by?c.textContent=`${e.by}`:c.remove();let s=e.descendants||e.kids.length,d=o.querySelector("span");s?d.textContent=`\u{1F5E8} ${s}`:d.remove();let u=o.querySelector("time");e.time?(u.textContent=`\u{23F2}${Item.renderAge(1e3*e.time,Date.now())} `,o.addEventListener("click",Item.onExpand)):u.remove();let m=o.querySelector('button[name="reply"]');e.reply?m.addEventListener("click",Item.onReply):m.remove();let p=t.querySelector("section");if(e.text){let t=document.createElement("div");t.innerHTML=e.text,t.querySelectorAll("a")?.forEach(e=>e.setAttribute("target","_blank")),"comment"===e.type?o.insertAdjacentElement("afterend",t):p.insertAdjacentElement("afterbegin",t)}if(e.kids.length){let t=p.querySelector("button");t.textContent=`\u{271B}${e.kids.length}`,t.addEventListener("click",Item.onLoad),p.insertAdjacentElement("beforeend",t)}else"comment"!==e.type&&("comment"===e.type||e.text)||t.querySelector("details").remove();return t}static renderAge(e,t){let n=t-e,r=Math.floor(n/1e3),o=Math.floor(n/6e4),l=Math.floor(n/36e5),i=Math.floor(n/864e5);return r<60?`${r} ${1===r?"second":"seconds"}`:o<60?`${o} ${1===o?"minute":"minutes"}`:l<24?`${l} ${1===l?"hour":"hours"}`:`${i} ${1===i?"day":"days"}`}}
class App extends HTMLElement{static TAG="app-main";#e=!1;#t;constructor(){super()}get isConnected(){return this.#e}set isConnected(e){this.#e=e}get user(){return this.#t}set user(e){this.#t=e}initialize(){return"http:"===location.protocol?fetch("/user").then(e=>{if(!e.ok)throw Error("Server error for /user");return e.json()}).then(({user:e})=>{HN.user=new HN({user:e});let t=document.createElement(Page.TAG,Page);t.setAttribute("id","user");let r=document.querySelector("nav");r.add("user",e);let n=document.querySelector("main");n.isConnected=!0,n.user=e,n.querySelector("aside").remove(),r.querySelector('a[href="#login"]').remove(),n.appendChild(t),r.initialize()}):document.querySelector("nav").initialize(),this}}customElements.define(App.TAG,App,{extends:"main"});
window.onload=function(){document.querySelector("main").initialize()};
